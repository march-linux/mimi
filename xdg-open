#!/bin/bash

err() {
	echo $1
	usage
	exit
}

usage() {
	cat <<EOF

Usage: xdg-open [file|directory|url]

It opens a file according to the extension
To setup the extension, create ~/.config/mimi/mime.conf
e.g.
	default:urxvt -e ranger
	pdf:mupdf
mimi :)
EOF
}

find_program() {
	grep "^$1:" "$CONFIG" | cut -d : -f 2
}

CONFIG="$HOME/.config/mimi/mime.conf"
[[ -f "$CONFIG" ]] || err "No configuration file found."

argument="$@"
program=""

if [[ "$argument" =~ ^file://(.*) ]]; then
	# make sure file:// urls are handled just like files
	argument="${BASH_REMATCH[1]}"
fi

if [[ "$argument" =~ ^([a-zA-Z]+): ]]; then
	# handle url
	protocol="${BASH_REMATCH[1]}"
	program="$(find_program "$protocol")"
elif [[ -f "$argument" ]]; then
	# handle file
	filename="$@"
	ext="${filename##*.}"
	program="$(find_program "$ext")"
elif [[ -d "$argument" ]]; then
	# handle directory
	program="$(find_program directory)"
else
	err "File or directory not found: $@"
fi

if [[ "$program" == "" ]]; then
	# default
	program=$(find_program default)
fi

$program "$argument"