#!/bin/bash

CONFIG="$HOME/.config/mimi/mime.conf"

find_in_config() {
    [[ -r "$CONFIG" ]] || return
    grep -m 1 "^$1: " "$CONFIG" | cut -d ' ' -f 2-
}

need_terminal() {
    grep -m 1 -qs "^Terminal=true$" "$1"
}

find_exec_in_desktop_file() {
    grep -m 1 "^Exec=" "$1" | cut -d = -f 2 | cut -d ' ' -f 1
}

find_terminal() {
    find_exec_in_desktop_file "$(find_desktop_file_by Categories TerminalEmulator)"
}

find_desktop_file_by() {
    SEARCHPATH="/usr/share/applications/"
    if [[ -d "$HOME/.local/share/applications" ]]; then
        SEARCHPATH="$HOME/.local/share/applications $SEARCHPATH"
    fi
    grep -m 1 "^$1=.*$2" -R $SEARCHPATH | awk -F : -v pat="$2" '{ print index($2, pat), length($2), $1 }' | sort -t ' ' -k1,1n -k2,2nr | head -n 1 | cut -d ' ' -f 3
}

url_decode() {
    echo -e "$(sed 's/%\([a-f0-9A-F]\{2\}\)/\\x\1/g' <<<"$1")"
}

fork_run() {
    "$@" &>/dev/null &
    exit 0
}

usage() {
    cat <<EOF

    Usage: xdg-open [file|directory|protocol]

    It opens a file according to the extension
    To setup the extension, create $CONFIG

    mimi :)
EOF
    exit 1
}

# config
# 1. ext
# 2. protocol
# 3. mime
# 4. general mime
# .desktop (mime and general mime)
# 5. ask

[[ ! "$1" ]] && usage

arg="$1"
ext=""
protocol=""
mime=""
general_mime=""

# fix file://
if [[ "$arg" =~ ^file://(.*) ]]; then
    # strip file://
    arg="$(url_decode "${BASH_REMATCH[1]}")"
    protocol=file
fi

if [[ -e "$arg" ]]; then
    # file or dir
    mime="$(file -b --mime-type "$arg")"
    if [[ -f "$arg" ]]; then
        # very short file
        [[ "$mime" =~ ^(inode/x-empty|application/octet-stream)$ ]] && mime=text/plain
        ext="${arg##*.}"
    fi
fi

# protocol to mime
if [[ "$arg" =~ ^([a-zA-Z]+): ]]; then
    # use protocol to guess mime
    protocol="${BASH_REMATCH[1]}"
    if [[ "$protocol" =~ ^https?$ ]]; then
        mime=text/html
    elif [[ "$protocol" == magnet ]]; then
        mime=application/x-bittorrent
    elif [[ "$protocol" == irc ]]; then
        mime=x-scheme-handler/irc
    fi
fi


# application mime is specific
[[ "$mime" =~ ^(audio|image|text|video)/ ]] && general_mime="${mime%%/*}/"

# config
for search in $ext $protocol $mime $general_mime; do
    app="$(find_in_config "$search")"
    [[ "$app" ]] && fork_run $app "$arg"
done

terminal="$(find_terminal)"
# .desktop
for search in $mime $general_mime; do
    desktop="$(find_desktop_file_by MimeType "$search")"
    if [[ "$desktop" ]]; then
        # find our own
        echo "$desktop"
        app="$(find_exec_in_desktop_file "$desktop")"
        if need_terminal "$desktop" && [[ "$terminal" ]]; then
            fork_run "$terminal" -e "$app" "$arg"
        else
            fork_run "$app" "$arg"
        fi
    fi
done

# ask
choice="$(IFS=: && stest -flx $PATH | sort -u | dmenu -p "how to open $arg ($mime)")"
[[ "$choice" ]] && fork_run $choice "$arg"
